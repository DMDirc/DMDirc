<?xml version="1.0" encoding="UTF-8"?>
<project name="DMDirc-ivy" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant">
    <description>Ivy utilities for DMDirc</description>

    <property name="ivy.cache.ttl.default" value="7d"/>

    <target name="-init-ivy" depends="-init-lib-directory">
        <path id="ivy.classpath">
           <fileset dir="etc/ivy" includes="ivy*.jar"/>
        </path>

        <available classname="org.apache.ivy.ant.IvyConfigure"
              property="ivy.available" classpathref="ivy.classpath" />
    </target>

    <target name="-init-dependencies" depends="-init-ivy" unless="ivy.done">
        <taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant" classpathref="ivy.classpath"/>
        <ivy:settings file="etc/ivy/ivysettings.xml"/>
        <ivy:retrieve symlink="true" pattern="lib/[conf]/[artifact].[ext]" sync="true" />
        <property name="ivy.done" value="true"/>
    </target>

    <target name="publish-integration" depends="-init-dependencies,jar">
        <copy file="dist/DMDirc.jar" tofile="dist/client.jar"/>
        <ivy:deliver deliverpattern="build/ivy.xml" pubrevision="${git.version}-SNAPSHOT" />
        <ivy:makepom ivyfile="build/ivy.xml" pomfile="dist/client.pom">
            <mapping conf="main" scope="compile"/>
        </ivy:makepom>
        <ivy:resolve file="build/ivy.xml"/>
        <ivy:retrieve/>
        <ivy:publish resolver="dmdirc-snapshots"
                     organisation="com.dmdirc"
                     module="client"
                     revision="${git.version}-SNAPSHOT"
                     status="integration"
                     artifactspattern="dist/[artifact].[ext]"
                     publishivy="false">
        </ivy:publish>
    </target>

    <target name="publish-from-teamcity" depends="-init-dependencies">
        <echo>Downloading private files, if this fails please pass username and</echo>
        <echo>password to ant using -Dusername=... -Dpassword=...</echo>

        <get src="http://www.dmdirc.com/private/nexus-teamcity.properties" dest="etc/nexus-teamcity.properties" username="${username}" password="${password}"/>
        <loadproperties srcFile="etc/nexus-teamcity.properties"/>

        <ivy:settings>
          <credentials host="nexus.dmdirc.com" realm="Sonatype Nexus Repository Manager" username="${nexus.user}" passwd="${nexus.pass}"/>
        </ivy:settings>
    </target>
</project>
