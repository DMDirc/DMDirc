<?xml version="1.0" encoding="UTF-8"?>
<project name="DMDirc" default="default" basedir=".">
    <description>Builds, tests, and runs the project DMDirc.</description>

    <available file="/bin/bash" property="has.bash"/>

    <import file="nbproject/build-impl.xml"/>
    <import file="build-installer.xml"/>
    <import file="build-jar.xml"/>
    <import file="build-plugins.xml"/>
    <import file="build-reports.xml"/>
    <import file="build-tests.xml"/>
    <import file="build-versioning.xml"/>

    <target name="-submodules" depends="-submodules-bash, -submodules-default"/>

    <target name="-check-use">
        <!-- Auto Update if:
               - submodule.autoupdate is set to true or none of the submodules
                 are checked out
          -->
        <contition property="doautoupdate">
            <or>
                <equals arg1="${submodule.autoupdate}" arg2="true" />
                <not>
                    <or>
                        <available file="modules/parser/.git">
                        <available file="modules/plugins/.git">
                        <available file="modules/defaults/.git">
                    </or>
                </not>
            </or>
        </condition>

        <!-- Use script if:
               - bash is available
               - autoupdating is enabled
               - updateSubModules.sh exists
          -->
        <condition property="use.bash.submodule">
            <and>
                <equals arg1="${has.bash}" arg2="true" />
                <equals arg1="${doautoupdate}" arg2="true" />
                <available file="updateSubModules.sh"/>
            </and>
        </condition>

        <!-- Use gits built in commands if:
               - autoupdating is enabled
               - we aren't using bash
          -->
        <condition property="use.default.submodule">
            <and>
                <equals arg1="${doautoupdate}" arg2="true" />
                <not>
                    <equals arg1="${use.bash.submodule}" arg2="true" />
                </not>
            </and>
        </condition>
    </target>


    <target name="-submodules-bash" depends="-check-use" if="use.bash.submodule">
        <exec executable="/bin/bash" failonerror="true">
            <arg value="updateSubModules.sh"/>
        </exec>
    </target>

    <target name="-submodules-default" depends="-check-use" if="use.default.submodule">
        <exec executable="git">
            <arg value="submodule"/>
            <arg value="init"/>
        </exec>
        <exec executable="git">
            <arg value="submodule"/>
            <arg value="update"/>
        </exec>
    </target>

    <target name="-pre-init" depends="-submodules"/>
    <target name="-post-compile" depends="-write-version, build-plugins, -addpluginlibs"/>
    <target name="-post-test-run" depends="-do-test-reports"/>
    <target name="-post-jar" depends="-addjarlibs"/>

</project>
