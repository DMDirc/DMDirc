<?xml version="1.0" encoding="UTF-8"?>
<project name="DMDirc-versioning" default="default" basedir=".">
    <description>Adds automatic versioning information to DMDirc</description>

    <property name="version.config" value="build/classes/com/dmdirc/version.config"/>
    <property name="defaults.path" value="src/com/dmdirc/config/defaults/"/>
    <property name="defaults.target" value="build/classes/com/dmdirc/config/defaults/default/defaults"/>

    <available file=".git" property="is.git"/>
    <available file=".svn" property="is.svn"/>

    <target name="-write-version" depends="-write-version-header, -add-version, -write-updater, -write-identities"/>

    <target name="-write-version-header">
        <echo file="${version.config}"># This is a DMDirc configuration file automatically generated by
# the build process.

keysections:
   identity
   version
   updater

identity:
   name=DMDirc version information
   globaldefault=true
   order=95000

version:
   version=</echo>
    </target>

    <target name="-add-version" depends="-add-git-version, -add-svn-version"/>

    <target name="-add-git-version" if="is.git">
        <exec executable="git" output="${version.config}" append="true">
            <arg value="describe"/>
            <arg value="--tags"/>
        </exec>
    </target>

    <target name="-add-svn-version" if="is.svn">
        <exec dir="." executable="/bin/bash" output="${version.config}" append="true">
            <arg value="-c"/>
            <arg value="svn log -l 1 | grep ^Git-version | cut -f 2 -d ' '"/>
        </exec>
    </target>

    <target name="-init-channel" unless="channel">
        <property name="channel" value="NONE"/>
    </target>

    <target name="-write-updater" depends="-init-channel, -read-identities">
        <echo file="${version.config}" append="true">
updater:
    channel=${channel}
    bundleddefaultsversion=${defaults.version}</echo>
    </target>

    <target name="-write-identities" depends="-read-identities">
        <echo file="${defaults.target}" append="true">
identity:
  defaultsversion=${defaults.version}</echo>
    </target>

    <target name="-read-identities" depends="-read-identities-git, -read-identities-svn"/>

    <target name="-read-identities-git" if="is.git">
        <exec dir="." executable="/bin/bash" outputproperty="defaults.version">
            <arg value="-c"/>
            <arg value="git rev-list --all -n 1 -- ${defaults.path} | xargs git describe --tags"/>
        </exec>
    </target>

   <target name="-read-identities-svn" if="is.svn">
        <exec dir="." executable="/bin/bash" outputproperty="defaults.version">
            <arg value="-c"/>
            <arg value="svn log ${defaults.path} -l 1 | grep ^Git-version | cut -f 2 -d ' '"/>
        </exec>
   </target>

</project>
