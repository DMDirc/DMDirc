<?xml version="1.0" encoding="UTF-8"?>
<project name="DMDirc-versioning" default="default" basedir=".">
    <description>Adds automatic versioning information to DMDirc</description>

    <property name="version.config" value="build/classes/com/dmdirc/version.config"/>
    <property name="defaults.path" value="modules/defaults/.git/"/>
    <property name="defaults.output" value="build/classes/com/dmdirc/config/defaults/"/>
    <property name="defaults.target" value="${defaults.output}default/defaults"/>
    <property name="modealiases.target" value="${defaults.output}modealiases/generic"/>

    <available file=".git" property="is.git"/>

    <target name="-init-version">
        <taskdef name="git-describe" classname="org.mdonoughe.JGitDescribeTask" classpathref="build-classpath"/>
    </target>

    <target name="-write-version" depends="-init-version, -write-version-header, -add-version, -write-updater, -write-identities, -write-disable-updates"/>

    <target name="-write-version-header">
        <echo file="${version.config}"># This is a DMDirc configuration file automatically generated by
# the build process.

keysections:
   identity
   version
   updater

identity:
   name=DMDirc version information
   globaldefault=true
   order=95000

version:
   version=</echo>
    </target>

    <target name="-add-version" depends="-add-git-version"/>

    <target name="-add-git-version" if="is.git">
        <git-describe dir=".git" property="git.version" />
        <echo file="${version.config}" append="true">${git.version}
</echo>
    </target>

    <target name="-init-channel" unless="channel">
        <property name="channel" value="NONE"/>
    </target>

    <target name="with.disabled.updater">
        <property name="disableupdates" value="true" />
    </target>

    <target name="-write-disable-updates" if="disableupdates">
        <echo file="${version.config}" append="true">
version:
    noupdates=true
</echo>
    </target>

    <target name="-write-updater" depends="-init-channel, -read-identities">
        <echo file="${version.config}" append="true">
updater:
    channel=${channel}
    bundleddefaultsversion=${defaults.version}
    bundledmodealiasesversion=${modealiases.version}
</echo>
    </target>

    <target name="-write-identities" depends="-read-identities, -copy-identities">
        <echo file="${defaults.target}" append="true">
identity:
  defaultsversion=${defaults.version}
</echo>
        <echo file="${modealiases.target}" append="true">
identity:
  modealiasversion=${modealiases.version}
</echo>
    </target>

    <target name="-copy-identities">
        <mkdir dir="${defaults.output}"/>
        <copy todir="${defaults.output}" overwrite="true">
            <fileset dir="modules/defaults/" excludes=".git/"/>
        </copy>
    </target>

    <target name="-read-identities" depends="-read-identities-git"/>

    <target name="-read-identities-git" if="is.git">
        <git-describe dir="${defaults.path}" property="defaults.version" subdir="default" />
        <git-describe dir="${defaults.path}" property="modealiases.version" subdir="modealiases" />
    </target>

</project>
